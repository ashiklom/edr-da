\section{Methods}

\subsection{ED2 model description}

The Ecosystem Demography version 2.2 (ED2) model simulates plot-level vegetation dynamics and biogeochemistry~\citep{moorcroft_2001_method, medvigy2009mechanistic, longo_2019_ed1}.
By grouping individuals of similar size, structure, and composition together into cohorts, ED2 is capable of modeling patch-level competition in a computationally efficient manner.
Relevant to this work, ED2 includes a multi-layer canopy radiative transfer model that is a generalization of the two-layer two-stream radiative transfer scheme in CLM 4.5~\citep{clm45_note}, which in turn is derived from \citet{sellers1985canopy}.
A complete description of the model derivation is provided in the supplementary information of \citet{longo_2019_ed1}, but for completeness, we provide an abbreviated description below:

Let $n$ be the number of cohorts in a patch.
The full canopy radiation profile in ED2 is then defined by a vector $\vec{X}$ that contains two fluxes---upward ($\vec{F}_{\up,i}$) and downward ($F_{\down,i}$)---for each cohort level $i$, plus a downward flux from the atmosphere ($F_{\down,\sky}$) and an upward flux from the ground ($F_{\up,\ground}$) surface (total size $2n + 2$):

\begin{equation}
  \vec{X} =
  \begin{bmatrix}
    F_{\up,\ground} \\
    F_{\down,1} \\
    F_{\up, 1} \\
    ... \\
    F_{\down,i} \\
    F_{\up,i} \\
    ... \\
    F_{\down,n} \\
    F_{\up,n} \\
    F_{\down,\sky}
  \end{bmatrix}
\end{equation}

ED2 solves this vector using the following matrix equation:

\begin{equation}
  \mat{M} \times \vec{X} = \vec{Y}
\end{equation}

where $\mat{M}$ is a $(2n + 2) \times (2n + 2)$ coefficient matrix and $\vec{Y}$ is a $2n + 2$ vector.
The full form of $\vec{Y}$ is as follows:

\begin{equation}
  \vec{Y} =
  \begin{bmatrix}
    S_0 a_{\ground} \\
    S_1 r(\psi)_1 \left[ 1 - r_0 r_1 (1 - \alpha_0) (1 - \tau_0) (1 - \alpha_1) (1 - \tau_1) \right] (1 - \tau(\psi)_1) (1 - \alpha_1) \\
    S_1 \left[ 1 - r_1 r_2 (1 - \alpha_1) (1 - \tau_1) (1 - \alpha_2) (1 - \tau_2) \right] (1 - \tau(\psi)_1) (1 - \alpha_1) (1 - r(\psi)_1) \\
    \ldots \\
    S_i r(\psi)_i \left[ i - r_{i-1} r_i (1 - \alpha_{i-1}) (1 - \tau_{i-1}) (1 - \alpha_i) (1 - \tau_i) \right] (1 - \tau(\psi)_i) (1 - \alpha_i) \\
    S_i \left[ 1 - r_i r_{i+1} (1 - \alpha_i) (i - \tau_i) (1 - \alpha_{i+1}) (1 - \tau_{i+1}) \right] (1 - \tau(\psi)_i) (1 - \alpha_i) (1 - r(\psi)_i) \\
    \ldots \\
    S_n r(\psi)_n \left[ 1 - r_{n-1} r_n (1 - \alpha_{n-1}) (1 - \tau_{n-1}) (1 - \alpha_n) (1 - \tau_n) \right] (1 - \tau(\psi)_n) (1 - \alpha_n) \\
    S_1 \left[ 1 - r_n r_{n+1} (1 - \alpha_n) (1 - \tau_n) (1 - \alpha_{n+1}) (1 - \tau_{n+1}) \right] (1 - \tau(\psi)_n) (1 - \alpha_n) (1 - r(\psi)_n) \\
    \mathrm{SW}_{\sky}
  \end{bmatrix}
\end{equation}

Here, $a_{\ground}$ is the albedo of the ground under the canopy and $\mathrm{SW}_{\sky}$ is the incident shortwave hemispherical flux from the sky;
both are exogenous inputs to the model.
$S_i$ is the direct ("beam") radiation at layer $i$, and is calculated in a loop as follows:

\begin{equation}
  S_i = S_{i + 1} \tau(\psi)_i
\end{equation}

with $S_{n+1}$ as the incident direct solar flux, an exogenous input.

Other coefficients are
backscatter of direct ($r(\psi)_{i}$, given zenith angle $\psi$) and diffuse ($r_{i}$) radiation,
interception of direct ($tau(\psi)_{i}$) and diffuse ($tau_{i}$) radiation,
and absorption ($\alpha_{i}$).
Derivations of each of these coefficients is given later in this section.

The coefficient matrix $\mat{M}$ is a sparse matrix with zero elements every except the diagonal and first-order off-diagonal elements; for example, for $n=3$:

\begin{equation}
  \mat{M} = \begin{bmatrix}
    1 & 0 & 0 & 0 & 0 & 0 \\
    m_{2,1} & m_{2,2} & m_{2,3} & 0 & 0 & 0 \\
    0 & m_{3,2} & m_{3,3} & m_{4,3} & 0 & 0 \\
    0 & 0 & m_{4,3} & m_{4,4} & m_{4,5} & 0 \\
    0 & 0 & 0 & m_{5,4} & m_{5,5} & m_{5,6} \\
    0 & 0 & 0 & 0 & 0 & 1 \\
  \end{bmatrix}
\end{equation}

For $i = 1,2,3...n$ where $n$ is the number of cohorts, the $m$ terms are defined as follows:

\begin{align}
  \begin{split}
    m_{1,1} &= 1\\
    m_{2i,2i-1} &= - \left[ \tau_i + (1 - \tau_i)(1 - \alpha_i)(1 - r_i) \right]\\
    m_{2i,2i} &= -r_{i-1} \left[ \tau_i + (1 - \tau_i)(1 - \alpha_i)(1 - r_i) \right] (1 - \alpha_{i-1})(1 - \tau_{i-1})\\
    m_{2i,2i+1} &= 1 - r_{i-1} r_i (1 - \alpha_{i-1})(1 - \tau_{i-1})(1 - \alpha_i)(1 - \tau_i)\\
    m_{2i+1,2i} &= 1 - r_i r_{i+1} (1 - \alpha_i)(1 - \tau_i)(1 - \alpha_{i+1})(1 - \tau_{i+1})\\
    m_{2i,2i} &= -r_{i+1} \left[ \tau_i + (1 - \tau_i)(1 - \alpha_i)(1 - r_i) \right] (1 - \alpha_{i+1})(1 - \tau_{i+1})\\
    m_{2i+1,2i+2} &= - \left[ \tau_i + (1 - \tau_i)(1 - \alpha_i)(1 - r_i) \right]\\
    m_{2n+2,2n+2} &= 1
  \end{split}
\end{align}

Canopy optical property coefficients are derived as follows:

Following \citet{clm45_note}, forward- ($\nu$) and backscattering ($\omega$) of canopy elements (leaves or stems) are defined as a function of those elements' reflectance ($R$) and transmittance ($T$; wood transmittance is assumed to be zero).
(We use index $p$ to refer to plant functional type and $p(i)$ to refer to the plant functional type of cohort $i$).

\begin{align}
  \begin{split}
    \nu_{i, \leaf} &= R_{p(i), \leaf} + T_{p(i), \leaf}\\
    \nu_{i, \wood} &= R_{p(i), \wood}\\
  \end{split}
\end{align}

\begin{align}
  \begin{split}
    \omega_{i, \leaf} &= \frac{R_{p(i), \leaf} + T_{p(i), \leaf} + \frac{1}{4} (R_{p(i), \leaf}-T_{p(i), \leaf})(1 - \chi_{p(i)})^2}{2 (R_{p(i), \leaf}+T_{p(i), \leaf})}\\
    \omega_{i, \wood} &= \frac{R_{p(i), \wood} + \frac{1}{4} (R_{p(i), \wood})(1 - \chi_{p(i)})^2}{2 R_{p(i), \wood}}
  \end{split}
\end{align}

where $\chi$ is the \emph{leaf orientation factor} parameter, defined such that $-1$ is perfectly vertical leaves, 1 is perfectly horizontal leaves, and 0 is randomly distributed leaf angles.
Both of these quantities are calculated independently for leaves and wood, and then averaged based on the relative effective area of leaves ($L_{i}$) and wood ($W_{i}$) within a canopy layer.

\begin{equation}
  \nu_{i} = \nu_{i, \leaf} \frac{L_{i}}{L_{i} + W_{i}} + \nu_{i, \wood} (1 - \frac{L_{i}}{L_{i} + W_{i}})
\end{equation}

\begin{equation}
  \omega_{i} = \omega_{i, \leaf} \frac{L_{i}}{L_{i} + W_{i}} + \omega_{\wood} (1 - \frac{L_{i}}{L_{i} + W_{i}})
\end{equation}

To account for non-uniform distribution of leaves within a canopy, ED2 has a PFT-specific \emph{clumping factor} ($q$) parameter that serves as a scaling factor on leaf area index.
Therefore the effective leaf area ($L$) is related to the true leaf area index ($\LAI$) by:

\begin{equation}
  L_{i} = \LAI_{i} \times q_{p(i)}
\end{equation}

The leaf area of a cohort ($\LAI_{i}$) is calculated as a function of leaf biomass ($B_{\leaf, i}$, \unit{kg C ~ plant^{-1}}), specific leaf area ($\SLA_{p}$, \unit{m^2 ~ kgC^{-1}}), and stem density ($n_{\plant}$, \unit{plants ~ m^{-2}}):

\begin{equation}
  \LAI_{i} = n_{\plant, i} B_{\leaf, i} \SLA_{p(i)}
\end{equation}

In turn, $B_{\leaf, i}$ is calculated from cohort diameter at breast height ($\DBH_{i}$, \unit{cm}) according to the following allometric equations:

\begin{equation}
  B_{\leaf, i} = \b1bl_{p(i)} \DBH_{i}^{\b2bl_{p(i)}}
\end{equation}

where $\b1bl_{p(i)}$ and $\b2bl_{p(i)}$ are PFT-specific parameters.
The wood area of a cohort ($\WAI_{i}$) is calculated directly from DBH according to a similar allometric equation:

\begin{equation}
  \WAI_{i} = n_{\plant, i} \b1bw_{p(i)} \DBH_{i}^{\b2bw_{p(i)}}
\end{equation}

where $\b1bw_{p(i)}$ and $\b2bw_{p(i)}$ are PFT-specific parameters.

The directional extinction coefficient ($K(\psi)_p$)---closely related to the inverse optical depth for direct radiation ($\mu_{0,p}$)---can be expressed as:

\begin{equation}
  K(\psi)_p = \mu_{0,p}^{-1} = \frac{G(\psi)_{p}}{\cos(\psi)}
\end{equation}

where $G(\psi)_{p}$ describes the mean projection per unit leaf area (or ``relative projected leaf area'') in direction $\psi$.

The leaf angle distribution function used in ED2 is the same as the one used in CLM 4.5 \citep{clm45_note}:

\begin{equation}
  G(\psi)_{p} = \phi_{1,p} + \phi_{2,p} \cos(\psi)
\end{equation}

\begin{equation}
  \phi_{1,p} = 0.5 - 0.633 \chi_{p} - 0.33 \chi_{p}^2
\end{equation}

\begin{equation}
  \phi_{2,p} = 0.877 (1 - 2 \phi_{1,p})
\end{equation}

Coefficients $\phi_{1,p}$ and $\phi_{2,p}$ are also used to define the inverse optical depth for diffuse radiation per unit plant area ($\bar\mu_{p}$) (subscript $p$ is omitted from the next three equations for convenience):

\begin{equation}
  \bar\mu = \frac{1}{\phi_{2}}\left( 1 - \frac{\phi_{1}}{\phi_{2}} \ln\left( 1 + \frac{\phi_{2}}{\phi_{1}}\right) \right)
\end{equation}

The beam backscatter (or "upscatter") coefficient for direct radiation, $\beta_0$, is defined as:

\begin{equation}
  \beta_{0} = a_s(\psi) \frac{1 + \bar\mu K(\psi)}{\bar\mu_{p} K(\psi)_{p}}
\end{equation}

where $a_s(\psi)$ is the single scattering albedo coefficient, defined as (subscript $p$ dropped for simplicity):

\begin{equation}
  a_s(\psi) = \frac{1}{2}
  \frac{G(\psi)}{\cos\psi \phi_2 + G(\psi)}
  \left(
    1 -
    \frac{\cos\psi \phi_1}{\cos\psi + G(\psi)}
    \ln\left(
      \frac{\cos\psi \phi_1 + \cos\psi \phi_2 + G(\psi)}{\cos\psi \phi_1}
    \right)
  \right)
\end{equation}

(For simplicity, $a_s$ here is equivalent to $\frac{a_s}{\omega}$ in \citet{clm45_note} equation 3.15, where $\omega$ is the leaf backscatter.)

The transmissivity of a layer to direct radiation for solar zenith angle $\psi$ ($\tau(\psi)_i$) is given by

\begin{equation}
  \tau(\psi)_i = \exp(-K(\psi)_{p(i)} \TAI_i)
\end{equation}

where $\TAI_{i}$ is the total plant area index (sum of effective leaf area index, $L_{i}$, and wood area index, $W_{i}$).

\subsection{ED2-PROSPECT coupling}

By default, ED2 performs canopy shortwave radiative transfer calculations for two broad spectral regions: visible (400--700 \unit{nm}) and near-infrared (700--2500 \unit{nm}).
For each of these regions, ED2 has user-defined prescribed leaf and wood reflectance and transmittance for each PFT, and calculates soil reflectance as the average of constant wet and dry soil reflectance values weighted by the relative soil moisture (0 = fully dry, 1 = fully wet).
In this study, we modified ED2 to perform the same canopy radiative transfer calculations but in 1 \unit{nm} increments across the range 400--2500 \unit{nm}.
We then simulated leaf reflectance and transmittance using the PROSPECT 5 leaf RTM,
which predicts leaf optical properties as a function of number of five parameters:
Effective number of leaf mesophyll layers (\emph{N}, unitless, >= 1),
total chlorophyll content (\emph{Cab}, \unit{\mu g ~ cm^{-2}}),
total carotenoid content (\emph{Car}, \unit{\mu g ~ cm^{-2}}),
water content (\emph{Cw}, \unit{g ~ cm^{-2}}),
and dry matter content (\emph{Cm}, \unit{g ~ cm^{-2}})
\citep{feret2008prospect4}.
For wood reflectance, we used a single representative spectrum---the mean of all wood spectra from \citet{asner_1998_biophysical}, resampled to 1 \unit{nm} resolution---for all PFTs.
For soil reflectance, we used the same approach as the ED2 default (weighted average of wet and dry soil reflectance, according to relative soil moisture parameter, $\varrho_{\soil}$, unitless, 0--1), but with full 1 \unit{nm} soil spectra from Hapke (REF). % TODO: Flesh this out
The final coupled PROSPECT-ED canopy radiative transfer model (hereafter known as ``EDR'') has 9 parameters for each PFT---
5 parameters for PROSPECT, specific leaf area, the intercept of the leaf allometry (slope was fixed), and clumping and orientation factors---and one site-specific parameter---the relative soil moisture.

% \subsection{Sensitivity analysis}

% To provide a basis for understanding the behavior of EDR, I performed a one-at-a-time sensitivity analysis to explore how its reflectance predictions vary with each leaf optical and canopy structural parameter.
% To assess the mathematical foundation of the EDR canopy model (i.e.\ the Sellers two-stream scheme) without the confounding influence of multiple cohorts, I first performed this sensitivity analysis on a simulated plot containing only a single mature tree cohort.
% For comparison, I also included simulations using the 4SAIL canopy radiative transfer model.
% The 4SAIL model simulates four reflectance ``streams''---diffuse (hemispherical) and direct (directional) reflectance for both diffuse and direct incident radiation---\
% but because EDR only simulates diffuse reflectance and its input is dominated by direct radiation (at least on sunny days, which are necessary for satellite and high-altitude airborne data), I used the ``directional-hemispherical'' output for all comparisons.
% For its representation of leaf angle distribution, 4SAIL uses an ellipsoidal model that takes as input the mean leaf inclination angle ($\theta$), which is related to EDR's leaf orientation factor ($\chi$) by:

% \begin{equation}\label{eq:orient_lidf}
%   \cos \theta = \frac{1 + \chi}{2}
% \end{equation}

% Unlike EDR, 4SAIL does not account for canopy clumping.
% (4SAIL does have a ``hot spot'' parameter to account for strong bi-directional reflectance effects from structurally heterogeneous canopies, but this parameter only affects the bi-directional reflectance, which was not used in this analysis).

% To investigate the way EDR models interactions between canopy layers, I also performed a similar sensitivity analysis on a simulated plot with two cohorts---a dominant early successional cohort and a sub-dominant mid-successional cohort.
% I examined the sensitivity of total canopy reflectance to the optical properties of both the dominant and sub-dominant cohort, and looked at how this sensitivity was affected by clumping in the upper cohort.

\subsection{Site and data description}

For model calibration, we selected 54 sites from the NASA Forest Functional Types (FFT) field campaign that contained plot-level inventory data (stem density, species identity, and diameter at breast height, DBH) coincident with observations of the NASA Airborne Visible/Infrared Imaging Spectrometer-Classic (AVIRIS-Classic).
These sites are located in the United States Upper Midwest, upstate New York, and western Maryland, and include stands dominated by either evergreen or deciduous trees and spanning a wide range of structures, from dense groups of saplings to sparse groups of large trees (Figure~\ref{fig:sites}).
We grouped the tree species in these sites into five different plant functional types (PFTs) as defined by ED2:
Early successional hardwood, northern mid-successional hardwood, late successional hardwood, northern pine, and late successional conifer.

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{figures/sitemap}
  \caption{\
    Sites selected for analysis, in ``stand structure'' (\textit{main figure}) and geographic (\textit{inset}) space.
  }\label{fig:sites}
\end{figure}

AVIRIS-Classic measures directional surface reflectance from 365 to 2500 \unit{nm} at approximately 10 \unit{nm} increments.
% TODO: Spatial averaging?
However, because of unrealistic values in the shortwave infrared spectral region (>1300 \unit{nm}) in the AVIRIS observations (likely caused by faulty atmospheric correction), we only used observations from 400 to 1300 \unit{nm} for model calibration and validation.

\subsection{Model calibration}

To estimate EDR parameters from AVIRIS observations, we used a Bayesian approach that builds on our previous work at the leaf scale \citep{shiklomanov2016quantifying}.
For a parameter vector $\vec{\Theta}$ and matrix of observations $\mat{X}$, the typical form of Bayes' rule is given by:

\begin{equation}
  P(\vec{\Theta} | \mat{X}) ~ \underbrace{P(\mat{X} | \vec{\Theta})}{\text{Likelihood}} \underbrace{P(\vec{\Theta})}{\text{Prior}}
\end{equation}

Rather than performing a separate calibration at each site, we performed a single calibration across all sites.
Our overall likelihood was therefore the product of the likelihood at each site; i.e. for site $s$:

\begin{equation}
  P(\mat{X} | \vec{\Theta}) = \prod_{s=1}^{n_{\site}} P(\mat{X}_{s} | \vec{\Theta})
\end{equation}

The likelihood at each site $s$ is based on how well EDR predicted surface reflectance ($R_{\mathrm{pred}, s}$) matches that site's observed AVIRIS surface reflectance ($\mat{X}_{s}$)
given the known forest composition at that site ($\mathrm{comp}_{s}$) and the current estimate of the overall parameter vector.
Similar to \citet{shiklomanov2016quantifying}, we assumed that a normally-distributed residual error between predicted and observed reflectance.
However, to account for the large differences in the range of feasible reflectance values in different wavelength regions
(for vegetation, reflectance in the 400-700 \unit{nm} range is typically much lower than in the 700-1400 \unit{nm} range),
we used a heteroskedastic error model, whereby the residual variance term was a linear function of the predicted reflectance (with slope $m_{r}$ and intercept $b_{r}$).
In addition, to mitigate sampling issues related to EDR's saturating response to increasing total LAI, we added an additional term to our likelihood that assigns a fixed lognormal probability distribution (with parameters 1 and 0.5, respectively) to the EDR predicted LAI for a given site ($\LAI_{\mathrm{pred}, s}$).
The expression for the site-specific likelihood is therefore:

\begin{equation}
  R_{\mathrm{pred}, s}, \LAI_{\mathrm{pred}, s} = \EDR(\vec{\Theta} | \mathrm{comp}_{s})
\end{equation}

\begin{equation}
  P(\mat{X}_{s} | \vec{\Theta}) =
  \mathrm{Normal}(\mat{X}_{s} | R_{\mathrm{pred}, s}, m R_{\mathrm{pred}, s} + b)
  \mathrm{LogNormal}(\LAI_{\mathrm{pred}, s} | 1, 0.5)
\end{equation}

Therefore, our parameter vector $\vec{\Theta}$ consists of the following:
10 EDR parameters per PFT ($\vec{\Theta}_{p}$)---the 5 parameters of the PROSPECT 5 model (\emph{N}, \emph{Cab}, \emph{Car}, \emph{Cw}, \emph{Cm}) and 5 EDR parameters related to canopy structure ($q$, $\chi$, $\SLA$, $\b1bl$, $\b1bw$)---,
1 parameter per site (relative soil moisture, $\varrho_{\soil, s}$),
and the residual slope ($m$) and intercept ($b$).
(With 5 PFTs and 54 sites, this means that $\vec{\Theta}$ has length $(10 \times 5) + 54 + 2 = 106$).

For priors on the 5 PROSPECT parameters and SLA, we performed a hierarchical multivariate analysis \citep{shiklomanov2020does} on PROSPECT parameters estimated from \citep[][Chapter 3]{shiklomanov_dissertation} and, where available, direct measurements of SLA.
For priors on the leaf biomass allometry parameters, we fit a multivariate normal distribution to allometry coefficients from \citet{jenkins_2003_allom,jenkins_2004_allom} using the \texttt{PEcAn.allometry} package.
For the clumping factor, we used a uniform prior across its full range (0 to 1), and for the leaf orientation factor, we used a weakly informative re-scaled beta distribution centered on 0.5.

To alleviate issues with strong collinearity between the allometry parameters and the specific leaf area, we fixed the allometry exponent parameters ($\b2bl$ and $\b2bw$) to their prior means for each plant functional type.
Doing so dramatically improved the stability of the inversion algorithm and the accuracy of the results.

\subsection{Analysis}

I evaluated the performance of the calibrated model by comparing the posterior credible intervals of modeled spectra against the AVIRIS observations at each site.
To assess the role of model structure in predictive error, I also included predictions using the 4SAIL model parameterized with the posterior means from the EDR calibration (except for clumping factor, which is absent from 4SAIL).
In addition, I compared model predictions of leaf area index (which depend on parameters calibrated in the model) against field observations.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../dissertation"
%%% End:
